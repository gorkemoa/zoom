<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toplantı - Python Zoom Klonu</title>
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --background-dark: #0f172a;
            --background-light: #1e293b;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            --danger-color: #dc2626;
            --success-color: #16a34a;
            --warning-color: #ca8a04;
        }

        body {
            background-color: var(--background-dark);
            color: var(--text-light);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* Video konteyneri için stil */
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 80px);
            background-color: var(--background-dark);
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        /* Video düzenleyici */
        .video-wrap {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 75%;
            border-radius: 1rem;
            overflow: hidden;
            background-color: var(--background-light);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .video-wrap:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        
        /* İki kullanıcı için daha büyük görüntü */
        .video-container.two-users {
            grid-template-columns: repeat(2, 1fr);
        }
        
        /* Tek kullanıcı için tam ekran */
        .video-container.one-user {
            grid-template-columns: 1fr;
        }
        
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: var(--background-light);
        }
        
        .local-video-wrap {
            border: 2px solid var(--primary-color);
        }
        
        /* İsim etiketi */
        .name-tag {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            backdrop-filter: blur(4px);
            z-index: 2;
        }
        
        /* Ses kontrolü */
        .audio-control {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-light);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
            z-index: 2;
        }
        
        .audio-control:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        /* Kontrol düğmeleri */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--background-light);
            position: fixed;
            bottom: 0;
            width: 100%;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .control-button {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }
        
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .control-button:active {
            transform: scale(0.95);
        }
        
        #hangupButton {
            background-color: var(--danger-color);
        }
        
        #hangupButton:hover {
            background-color: #b91c1c;
        }
        
        .control-button.active {
            background-color: var(--primary-color);
        }
        
        /* Oda bilgisi */
        .room-info {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(4px);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .copy-button {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .copy-button:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* Bağlantı durumu göstergesi */
        .connection-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            z-index: 2;
        }
        
        .connection-status.connecting {
            background-color: rgba(var(--warning-color), 0.7);
        }
        
        .connection-status.connected {
            background-color: rgba(var(--success-color), 0.7);
        }
        
        .connection-status.disconnected,
        .connection-status.failed,
        .connection-status.closed {
            background-color: rgba(var(--danger-color), 0.7);
        }
        
        /* Kalite menüsü */
        .quality-menu {
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            background-color: var(--background-light);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            width: 250px;
            padding: 1rem;
            z-index: 1000;
            transform: translateY(1rem);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .quality-menu.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .quality-menu-header {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0.5rem;
        }
        
        .quality-option {
            padding: 0.75rem 1rem;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .quality-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Mobil cihazlar için özel stiller */
        @media (max-width: 768px) {
            .video-container {
                height: calc(100vh - 70px);
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .controls {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .control-button {
                width: 3rem;
                height: 3rem;
            }

            .room-info {
                top: auto;
                bottom: 5rem;
                right: 1rem;
                font-size: 0.75rem;
                padding: 0.5rem 1rem;
            }

            .quality-menu {
                width: calc(100% - 2rem);
                left: 1rem;
                right: 1rem;
            }
        }

        /* Tablet cihazlar için özel stiller */
        @media (min-width: 769px) and (max-width: 1024px) {
            .video-container {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        /* Animasyonlar */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .video-wrap {
            animation: fadeIn 0.3s ease-out;
        }

        /* Dokunmatik cihazlar için iyileştirmeler */
        @media (hover: none) {
            .control-button:hover {
                transform: none;
            }

            .video-wrap:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="video-container" id="videoContainer">
            <!-- Video akışları burada görüntülenecek -->
        </div>
        
        <div class="controls">
            <div class="control-button" id="micToggle">
                <i class="fas fa-microphone"></i>
            </div>
            <div class="control-button" id="videoToggle">
                <i class="fas fa-video"></i>
            </div>
            <div class="control-button" id="screenShareToggle">
                <i class="fas fa-desktop"></i>
            </div>
            <div class="control-button" id="qualityToggle">
                <i class="fas fa-cog"></i>
            </div>
            <div class="control-button" id="hangupButton">
                <i class="fas fa-phone-slash"></i>
            </div>
            <div class="room-info">
                Oda ID: <span id="roomIdDisplay">{{ oda_id }}</span>
                <button class="copy-button" onclick="copyRoomId()"><i class="fas fa-copy"></i></button>
            </div>
        </div>
        
        <!-- Kalite ayarları menüsü -->
        <div class="quality-menu" id="qualityMenu">
            <div class="quality-menu-header">Video Kalitesi</div>
            <div class="quality-option" onclick="changeVideoQuality('low')">Düşük</div>
            <div class="quality-option" onclick="changeVideoQuality('medium')">Orta</div>
            <div class="quality-option" onclick="changeVideoQuality('high')">Yüksek</div>
            <div class="quality-option" onclick="toggleAutomaticQuality()">
                <span>Otomatik</span>
                <input type="checkbox" id="autoQualityToggle" checked>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        // Oda ID'sini değişkene atayalım
        const roomId = '{{ oda_id }}';
        let localStream = null;
        let peers = {};
        let localVideoEnabled = true;
        let localAudioEnabled = true;
        let socket = null;
        
        // DOM elementleri
        const videoContainer = document.getElementById('videoContainer');
        const micToggle = document.getElementById('micToggle');
        const videoToggle = document.getElementById('videoToggle');
        const screenShareToggle = document.getElementById('screenShareToggle');
        const hangupButton = document.getElementById('hangupButton');

        // WebRTC yapılandırması
        const peerConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                { urls: 'stun:stun.ekiga.net' },
                { urls: 'stun:stun.ideasip.com' },
                { urls: 'stun:stun.schlund.de' },
                // Ücretsiz TURN sunucuları ekleyelim
                {
                    urls: [
                        'turn:openrelay.metered.ca:80',
                        'turn:openrelay.metered.ca:443',
                        'turn:openrelay.metered.ca:443?transport=tcp'
                    ],
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:global.turn.twilio.com:3478?transport=udp',
                    username: 'f4809447', // demo amaçlı kullanıcı adı
                    credential: 'f4809447'  // demo amaçlı parola
                }
            ],
            iceCandidatePoolSize: 10
        };

        // Video kalitesi yapılandırması
        let videoQualitySettings = {
            low: {
                width: { ideal: 320, max: 640 },
                height: { ideal: 240, max: 480 },
                frameRate: { ideal: 15, max: 20 },
                facingMode: 'user'
            },
            medium: {
                width: { ideal: 640, max: 1280 },
                height: { ideal: 480, max: 720 },
                frameRate: { ideal: 24, max: 30 },
                facingMode: 'user'
            },
            high: {
                width: { ideal: 1280, max: 1920 },
                height: { ideal: 720, max: 1080 },
                frameRate: { ideal: 30, max: 60 },
                facingMode: 'user'
            }
        };

        // Mevcut video kalitesi seviyesi
        let currentQualityLevel = 'medium';
        
        // Bağlantı hızını ölçmek için değişkenler
        let lastConnectionCheck = 0;
        let connectionQualityCheckInterval = null;

        // Sayfanın yüklenmesini bekleyelim
        window.onload = async function() {
            try {
                // Önce orta kalitede başla
                await startVideoWithQuality(currentQualityLevel);
                
                // Yerel video akışını ekrana ekleyelim
                createVideoElement('local', localStream, true);

                // Socket.io bağlantısını kuralım
                socket = io();

                // Socket.io olaylarını dinleyelim
                socket.on('connect', () => {
                    console.log('Socket.io bağlantısı kuruldu');
                    socket.emit('join_room', { oda_id: roomId });
                });

                socket.on('user_joined', (data) => {
                    console.log('Yeni kullanıcı katıldı:', data.user_id);
                    connectToNewUser(data.user_id);
                });

                socket.on('existing_users', (data) => {
                    console.log('Mevcut kullanıcılar:', data.users);
                    data.users.forEach(userId => {
                        connectToNewUser(userId);
                    });
                });

                socket.on('user_left', (data) => {
                    console.log('Kullanıcı ayrıldı:', data.user_id);
                    if (peers[data.user_id]) {
                        // Düzgün temizlik için cleanup fonksiyonunu çağıralım
                        cleanup(data.user_id);
                    }
                });

                socket.on('signal', (data) => {
                    handleSignaling(data);
                });

                // Kontrol düğmeleri için olayları tanımlayalım
                micToggle.addEventListener('click', toggleMic);
                videoToggle.addEventListener('click', toggleVideo);
                screenShareToggle.addEventListener('click', toggleScreenShare);
                hangupButton.addEventListener('click', hangup);
                
                // Kalite ayarları menüsü
                const qualityToggle = document.getElementById('qualityToggle');
                const qualityMenu = document.getElementById('qualityMenu');
                
                qualityToggle.addEventListener('click', () => {
                    qualityMenu.classList.toggle('visible');
                });
                
                // Menü dışına tıklandığında menüyü kapat
                document.addEventListener('click', (event) => {
                    if (!qualityMenu.contains(event.target) && event.target !== qualityToggle) {
                        qualityMenu.classList.remove('visible');
                    }
                });

            } catch (error) {
                console.error('Kamera veya mikrofon erişiminde hata:', error);
                alert('Kamera veya mikrofon erişimi sağlanamadı. Lütfen izinleri kontrol edin.');
            }
        };

        // Yeni bir kullanıcıyla bağlantı kurar
        function connectToNewUser(userId) {
            console.log(`${userId} kullanıcısına bağlanmaya çalışılıyor...`);
            
            // Eğer bu kullanıcı ile zaten bir bağlantı varsa, kullanmayalım
            if (peers[userId]) {
                console.log(`${userId} ile zaten bir bağlantı var, yenisi oluşturulmuyor.`);
                return;
            }
            
            const peerConnection = new RTCPeerConnection(peerConfig);
            peers[userId] = peerConnection;
            
            // Bekleyen ICE adayları için dizi oluştur
            peers[userId]._pendingIceCandidates = [];
            
            // Teklif oluşturup oluşturmadığımızı izleyen bayrak
            peers[userId]._isInitiator = true;

            // Peer için olay dinleyicilerini ayarla
            setupPeerListeners(userId);

            // Yerel medya akışını peer bağlantısına ekleyelim
            localStream.getTracks().forEach(track => {
                console.log(`Yerel ${track.kind} izi ekleniyor...`);
                peerConnection.addTrack(track, localStream);
            });

            // Teklif oluşturalım ve gönderelim
            peerConnection.createOffer()
                .then(offer => {
                    console.log(`Teklif oluşturuldu (${userId})`);
                    return peerConnection.setLocalDescription(offer);
                })
                .then(() => {
                    console.log(`Teklif gönderiliyor (${userId})`);
                    socket.emit('signal', {
                        to: userId,
                        signal: {
                            type: 'offer',
                            sdp: peerConnection.localDescription
                        }
                    });
                })
                .catch(error => console.error(`Teklif oluşturma hatası (${userId}):`, error));
        }

        // Bekleyen ICE adaylarını uygula
        function applyPendingIceCandidates(userId) {
            if (!peers[userId]) {
                console.warn(`${userId} için bekleyen ICE adayları uygulanamadı, peer bağlantısı yok`);
                return;
            }
            
            if (!peers[userId]._pendingIceCandidates || peers[userId]._pendingIceCandidates.length === 0) {
                console.log(`${userId} için bekleyen ICE adayı yok`);
                return;
            }
            
            // RemoteDescription kontrol et
            if (!peers[userId].remoteDescription || !peers[userId].remoteDescription.type) {
                console.warn(`${userId} için bekleyen ICE adayları uygulanamadı, remoteDescription henüz ayarlanmamış`);
                return;
            }
            
            const pendingCandidates = peers[userId]._pendingIceCandidates;
            console.log(`${userId} için ${pendingCandidates.length} bekleyen ICE adayı uygulanıyor`);
            
            const promises = pendingCandidates.map(candidate => {
                return peers[userId].addIceCandidate(new RTCIceCandidate(candidate))
                    .then(() => {
                        console.log(`${userId} için bekleyen ICE adayı başarıyla eklendi`);
                        return true;
                    })
                    .catch(error => {
                        console.error(`Bekleyen ICE adayı ekleme hatası (${userId}):`, error);
                        return false;
                    });
            });
            
            Promise.all(promises)
                .then(results => {
                    const successCount = results.filter(Boolean).length;
                    console.log(`${userId} için ${successCount}/${pendingCandidates.length} ICE adayı başarıyla eklendi`);
                    // Bekleyen adayları temizle
                    peers[userId]._pendingIceCandidates = [];
                });
        }
        
        // Sinyalleşme işlemlerini yönetir
        function handleSignaling(data) {
            const fromUserId = data.from;
            const signal = data.signal;
            console.log(`${fromUserId} kullanıcısından sinyal alındı:`, signal.type);
            
            // Kendimizden gelen sinyalleri işlemeyelim
            if (fromUserId === socket.id) {
                console.log("Kendimizden gelen sinyal, işlenmiyor.");
                return;
            }

            // Peer bağlantısı yoksa oluştur
            if (!peers[fromUserId]) {
                console.log(`${fromUserId} için yeni peer bağlantısı oluşturuluyor`);
                peers[fromUserId] = new RTCPeerConnection(peerConfig);
                
                // Bekleyen ICE adayları için dizi oluştur
                peers[fromUserId]._pendingIceCandidates = [];
                
                // Bu kullanıcı, teklifte bulunan taraf olmadığını işaretliyoruz
                peers[fromUserId]._isInitiator = false;

                // Bağlantı durumu değişikliklerini izle
                peers[fromUserId].onconnectionstatechange = (event) => {
                    console.log(`Bağlantı durumu (${fromUserId}): ${peers[fromUserId].connectionState}`);
                    
                    // Bağlantı başarısız olursa temizle
                    if (peers[fromUserId].connectionState === 'failed' || 
                        peers[fromUserId].connectionState === 'disconnected' ||
                        peers[fromUserId].connectionState === 'closed') {
                        console.log(`${fromUserId} ile bağlantı durumu: ${peers[fromUserId].connectionState}. Temizleniyor.`);
                        if (peers[fromUserId]) {
                            peers[fromUserId].close();
                            delete peers[fromUserId];
                        }
                    }
                };

                // Yerel medya akışını peer bağlantısına ekleyelim
                localStream.getTracks().forEach(track => {
                    console.log(`Yerel ${track.kind} izi ekleniyor...`);
                    peers[fromUserId].addTrack(track, localStream);
                });

                // ICE aday olayını dinleyelim
                peers[fromUserId].onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log(`ICE adayı gönderiliyor (${fromUserId})`);
                        socket.emit('signal', {
                            to: fromUserId,
                            signal: {
                                type: 'ice-candidate',
                                candidate: event.candidate
                            }
                        });
                    }
                };

                // Uzak akış olayını dinleyelim
                peers[fromUserId].ontrack = (event) => {
                    console.log(`Uzak medya akışı alındı (${fromUserId})`);
                    if (!document.getElementById(`video-${fromUserId}`)) {
                        createVideoElement(fromUserId, event.streams[0], false);
                    }
                };
            }

            // Sinyal tipine göre işlem yapalım
            if (signal.type === 'offer') {
                console.log(`${fromUserId} teklifini ayarlıyorum`);
                
                // Teklifi ayarlamadan önce bağlantı durumunu kontrol edelim
                if (peers[fromUserId].signalingState !== 'stable') {
                    console.log(`${fromUserId} için signaling durumu stable değil, önce kapatılıyor: ${peers[fromUserId].signalingState}`);
                    
                    // Çakışma çözümü için her iki tarafın da kendi teklifini rollback yapması gerekiyor
                    const myId = socket.id;
                    const otherIdLessThanMine = fromUserId < myId;
                    
                    // ID'si düşük olan kazanır yaklaşımı
                    if (otherIdLessThanMine) {
                        console.log(`${fromUserId} ile çakışma durumu, karşı tarafın ID'si daha düşük olduğu için onların teklifini kabul ediyoruz`);
                        
                        // Kendi teklifimizi rollback yapalım
                        Promise.resolve()
                            .then(() => {
                                if (peers[fromUserId].signalingState === 'have-local-offer') {
                                    // Eğer zaten bir teklifimiz varsa rollback
                                    return peers[fromUserId].setLocalDescription({type: 'rollback'});
                                }
                                return Promise.resolve();
                            })
                            .then(() => {
                                // Şimdi gelen teklifi işleyelim
                                return peers[fromUserId].setRemoteDescription(new RTCSessionDescription(signal.sdp));
                            })
                            .then(() => {
                                console.log(`${fromUserId} teklifine cevap oluşturuyorum`);
                                // Bekleyen ICE adaylarını ekle
                                applyPendingIceCandidates(fromUserId);
                                return peers[fromUserId].createAnswer();
                            })
                            .then(answer => {
                                console.log(`Yerel açıklamayı ayarlıyorum (cevap)`);
                                return peers[fromUserId].setLocalDescription(answer);
                            })
                            .then(() => {
                                console.log(`${fromUserId} kullanıcısına cevap gönderiyorum`);
                                socket.emit('signal', {
                                    to: fromUserId,
                                    signal: {
                                        type: 'answer',
                                        sdp: peers[fromUserId].localDescription
                                    }
                                });
                            })
                            .catch(error => console.error(`Rollback ve cevap oluşturma hatası (${fromUserId}):`, error));
                        return; // İşlemi tamamladık
                    } else {
                        console.log(`${fromUserId} ile çakışma durumu, bizim ID'miz daha düşük olduğu için biz kazanıyoruz, tekliflerini görmezden geliyoruz`);
                        return; // Bizim teklifimiz geçerli olacak, bu teklifi görmezden gel
                    }
                }
                
                // Normal durum - doğrudan teklifi kabul et
                peers[fromUserId].setRemoteDescription(new RTCSessionDescription(signal.sdp))
                    .then(() => {
                        console.log(`${fromUserId} teklifine cevap oluşturuyorum`);
                        // Bekleyen ICE adaylarını ekle
                        applyPendingIceCandidates(fromUserId);
                        
                        return peers[fromUserId].createAnswer();
                    })
                    .then(answer => {
                        console.log(`Yerel açıklamayı ayarlıyorum (cevap)`);
                        return peers[fromUserId].setLocalDescription(answer);
                    })
                    .then(() => {
                        console.log(`${fromUserId} kullanıcısına cevap gönderiyorum`);
                        socket.emit('signal', {
                            to: fromUserId,
                            signal: {
                                type: 'answer',
                                sdp: peers[fromUserId].localDescription
                            }
                        });
                    })
                    .catch(error => console.error(`Cevap oluşturma hatası (${fromUserId}):`, error));
            }
            else if (signal.type === 'answer') {
                console.log(`${fromUserId} cevabını ayarlıyorum`);
                
                // Cevabı ayarlamadan önce bağlantı durumunu kontrol edelim
                if (peers[fromUserId].signalingState === 'have-local-offer') {
                    peers[fromUserId].setRemoteDescription(new RTCSessionDescription(signal.sdp))
                        .then(() => {
                            console.log(`${fromUserId} için uzak açıklama başarıyla ayarlandı`);
                            // Bekleyen ICE adaylarını ekle
                            applyPendingIceCandidates(fromUserId);
                        })
                        .catch(error => console.error(`Uzak açıklama ayarlama hatası (${fromUserId}):`, error));
                } else {
                    console.warn(`${fromUserId} için cevap ayarlanamadı, mevcut durum: ${peers[fromUserId].signalingState}`);
                }
            }
            else if (signal.type === 'ice-candidate') {
                console.log(`${fromUserId} ICE adayını ekliyorum`);
                
                // Eğer peer bağlantısı mevcut değilse oluşturalım
                if (!peers[fromUserId]) {
                    console.log(`${fromUserId} için ICE adayı geldi ama peer bağlantısı yok, oluşturuluyor`);
                    peers[fromUserId] = new RTCPeerConnection(peerConfig);
                    peers[fromUserId]._pendingIceCandidates = [];
                    peers[fromUserId]._isInitiator = false;
                    
                    // Yerel medya akışını peer bağlantısına ekleyelim
                    localStream.getTracks().forEach(track => {
                        peers[fromUserId].addTrack(track, localStream);
                    });
                    
                    // Diğer olay dinleyicileri ekleyelim
                    setupPeerListeners(fromUserId);
                }
                
                // ICE adayını sadece remoteDescription ayarlandığında ekleyelim, 
                // aksi halde daha sonra eklenmek üzere saklayalım
                if (peers[fromUserId].remoteDescription && peers[fromUserId].remoteDescription.type) {
                    peers[fromUserId].addIceCandidate(new RTCIceCandidate(signal.candidate))
                        .then(() => {
                            console.log(`${fromUserId} için ICE adayı başarıyla eklendi`);
                        })
                        .catch(error => {
                            console.error(`ICE aday ekleme hatası (${fromUserId}):`, error);
                            // Hata durumunda bile adayı kaydedelim
                            if (!peers[fromUserId]._pendingIceCandidates) {
                                peers[fromUserId]._pendingIceCandidates = [];
                            }
                            peers[fromUserId]._pendingIceCandidates.push(signal.candidate);
                        });
                } else {
                    console.warn(`${fromUserId} için ICE adayı eklenemedi, remoteDescription ayarlanmamış`);
                    
                    // ICE adaylarını daha sonra eklenmek üzere saklayalım
                    if (!peers[fromUserId]._pendingIceCandidates) {
                        peers[fromUserId]._pendingIceCandidates = [];
                    }
                    peers[fromUserId]._pendingIceCandidates.push(signal.candidate);
                }
            }
        }

        // Peer için olay dinleyicilerini ayarlayan yardımcı fonksiyon
        function setupPeerListeners(userId) {
            if (!peers[userId]) return;
            
            // ICE aday olayını dinleyelim
            peers[userId].onicecandidate = (event) => {
                if (event.candidate) {
                    console.log(`ICE adayı gönderiliyor (${userId})`);
                    socket.emit('signal', {
                        to: userId,
                        signal: {
                            type: 'ice-candidate',
                            candidate: event.candidate
                        }
                    });
                } else {
                    console.log(`ICE toplama tamamlandı (${userId})`);
                }
            };
            
            // ICE bağlantı durumu değişikliklerini izleyelim
            peers[userId].oniceconnectionstatechange = (event) => {
                const state = peers[userId].iceConnectionState;
                console.log(`ICE bağlantı durumu (${userId}): ${state}`);
                
                // Bağlantı durumunu göster
                if (state === 'connected' || state === 'completed') {
                    updateConnectionStatus(userId, 'connected');
                    
                    // Bağlantı kurulduğunda otomatik kalite kontrolünü başlat
                    startConnectionQualityCheck();
                } else if (state === 'checking') {
                    updateConnectionStatus(userId, 'connecting');
                } else if (state === 'disconnected') {
                    updateConnectionStatus(userId, 'disconnected');
                } else if (state === 'failed') {
                    updateConnectionStatus(userId, 'failed');
                    // Bağlantıyı yeniden başlatmayı deneyebiliriz
                    restartIce(userId);
                } else if (state === 'closed') {
                    updateConnectionStatus(userId, 'closed');
                }
            };
            
            // Uzak akış olayını dinleyelim
            peers[userId].ontrack = (event) => {
                console.log(`Uzak medya akışı alındı (${userId})`, event.streams);
                
                if (event.streams && event.streams[0]) {
                    console.log(`${userId} için akış var, video elementini oluştur/güncelle`);
                    
                    // Akış bilgilerini görüntüle
                    const tracks = event.streams[0].getTracks();
                    tracks.forEach(track => {
                        console.log(`${userId} için ${track.kind} izi alındı: id=${track.id}, enabled=${track.enabled}`);
                    });
                    
                    // Video elementini oluştur veya güncelle
                    createVideoElement(userId, event.streams[0], false);
                    
                    // Akış değişikliklerini izle
                    event.streams[0].onaddtrack = (e) => {
                        console.log(`${userId} için yeni iz eklendi:`, e.track);
                        document.getElementById(`video-${userId}`).srcObject = event.streams[0];
                    };
                    
                    event.streams[0].onremovetrack = (e) => {
                        console.log(`${userId} için iz kaldırıldı:`, e.track);
                        
                        // Eğer tüm izler kaldırıldıysa video elementini güncelle
                        const remainingTracks = event.streams[0].getTracks();
                        if (remainingTracks.length === 0) {
                            console.log(`${userId} için tüm izler kaldırıldı`);
                            updateConnectionStatus(userId, 'disconnected');
                        }
                    };
                } else {
                    console.warn(`${userId} için akış bulunamadı!`);
                }
            };
            
            // ICE aday hatalarını dinleyelim
            peers[userId].onicecandidateerror = (event) => {
                console.error(`ICE Aday Hatası (${userId}):`, event);
            };
            
            // Bağlantı durumu değişikliklerini izleyelim
            peers[userId].onconnectionstatechange = (event) => {
                const state = peers[userId].connectionState;
                console.log(`Bağlantı durumu (${userId}): ${state}`);
                
                if (state === 'connected') {
                    console.log(`${userId} ile bağlantı başarıyla kuruldu`);
                    updateConnectionStatus(userId, 'connected');
                } else if (state === 'connecting') {
                    updateConnectionStatus(userId, 'connecting');
                } else if (state === 'disconnected') {
                    console.log(`${userId} ile bağlantı kesildi`);
                    updateConnectionStatus(userId, 'disconnected');
                } else if (state === 'failed') {
                    console.log(`${userId} ile bağlantı başarısız oldu`);
                    updateConnectionStatus(userId, 'failed');
                    
                    // Bağlantı başarısız olursa yeniden deneyebiliriz
                    setTimeout(() => {
                        if (peers[userId]) {
                            restartIce(userId);
                        }
                    }, 3000);
                } else if (state === 'closed') {
                    console.log(`${userId} ile bağlantı kapatıldı`);
                    updateConnectionStatus(userId, 'closed');
                    
                    // Bağlantı kapatıldıysa temizle
                    cleanup(userId);
                }
            };
            
            // Sinyalleşme durumu değişikliklerini izleyelim
            peers[userId].onsignalingstatechange = (event) => {
                console.log(`Sinyalleşme durumu (${userId}): ${peers[userId].signalingState}`);
            };
        }
        
        // ICE bağlantısını yeniden başlatır
        function restartIce(userId) {
            if (!peers[userId]) return;
            
            console.log(`${userId} için ICE bağlantısı yeniden başlatılıyor`);
            try {
                // ICE yeniden başlatma işlevini çağır
                peers[userId].restartIce();
                
                // Yeni bir teklif oluştur (ice restart ile)
                peers[userId].createOffer({ iceRestart: true })
                    .then(offer => {
                        console.log(`${userId} için ICE restart teklifi oluşturuldu`);
                        return peers[userId].setLocalDescription(offer);
                    })
                    .then(() => {
                        console.log(`${userId} için ICE restart teklifini gönderiyorum`);
                        socket.emit('signal', {
                            to: userId,
                            signal: {
                                type: 'offer',
                                sdp: peers[userId].localDescription
                            }
                        });
                    })
                    .catch(error => console.error(`ICE restart hatası (${userId}):`, error));
            } catch (error) {
                console.error(`ICE restart işlemi başlatılamadı (${userId}):`, error);
                
                // Yeniden bağlanmayı deneyelim
                reconnectPeer(userId);
            }
        }
        
        // Peer bağlantısını temizler
        function cleanup(userId) {
            if (peers[userId]) {
                peers[userId].close();
                delete peers[userId];
            }
            
            const videoElement = document.getElementById(`video-wrap-${userId}`);
            if (videoElement) {
                videoElement.remove();
                // Video düzenini güncelle
                updateContainerLayout();
            }
        }
        
        // Peer bağlantısını yeniden oluşturur
        function reconnectPeer(userId) {
            console.log(`${userId} için bağlantı yeniden oluşturuluyor`);
            
            // Önce eski bağlantıyı temizle
            cleanup(userId);
            
            // Sonra yeni bir bağlantı başlat
            setTimeout(() => {
                connectToNewUser(userId);
            }, 1000);
        }

        // Video elementi oluşturur ve konteynere ekler
        function createVideoElement(userId, stream, isLocal) {
            console.log(`Video elementi oluşturuluyor: userId=${userId}, isLocal=${isLocal}, stream=`, stream);
            
            // Eğer bu kullanıcı için zaten bir video elementi varsa, sadece akışı güncelleyelim
            const existingVideo = document.getElementById(`video-${userId}`);
            if (existingVideo) {
                console.log(`${userId} için mevcut video elementi bulundu, sadece akış güncelleniyor`);
                existingVideo.srcObject = stream;
                return;
            }
            
            // Yeni video elementi oluştur
            const videoWrap = document.createElement('div');
            videoWrap.className = 'video-wrap';
            videoWrap.id = `video-wrap-${userId}`;

            const video = document.createElement('video');
            video.id = `video-${userId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true; // iOS için önemli
            
            // Play işlemi için
            video.onloadedmetadata = () => {
                console.log(`${userId} video metadatası yüklendi, play() çağrılıyor`);
                video.play().catch(e => console.error(`Video oynatma hatası (${userId}):`, e));
            };
            
            if (isLocal) {
                video.muted = true;
                video.className = 'local-video';
                videoWrap.className += ' local-video-wrap';
            } else {
                // Karşı taraf için ses kontrolü ekleyelim
                const audioControl = document.createElement('div');
                audioControl.className = 'audio-control';
                audioControl.innerHTML = '<i class="fas fa-volume-up"></i>';
                audioControl.onclick = () => {
                    video.muted = !video.muted;
                    audioControl.innerHTML = video.muted
                        ? '<i class="fas fa-volume-mute"></i>'
                        : '<i class="fas fa-volume-up"></i>';
                };
                videoWrap.appendChild(audioControl);
            }

            const nameTag = document.createElement('div');
            nameTag.className = 'name-tag';
            nameTag.innerText = isLocal ? 'Sen' : `Kullanıcı ${userId.substring(0, 5)}`;

            videoWrap.appendChild(video);
            videoWrap.appendChild(nameTag);
            videoContainer.appendChild(videoWrap);
            
            // Uzak video için bağlantı durumunu göster
            if (!isLocal) {
                const connectionStatus = document.createElement('div');
                connectionStatus.className = 'connection-status';
                connectionStatus.id = `connection-status-${userId}`;
                connectionStatus.innerText = 'Bağlanıyor...';
                videoWrap.appendChild(connectionStatus);
                
                // Bağlantı durumunu güncelleyen bir fonksiyon
                updateConnectionStatus(userId, 'new');
            }
            
            console.log(`${userId} için video elementi oluşturuldu`);
            
            // Video düzenini güncelle
            updateContainerLayout();
        }

        // Bağlantı durumunu görsel olarak gösterir
        function updateConnectionStatus(userId, state) {
            const statusElement = document.getElementById(`connection-status-${userId}`);
            if (!statusElement) return;
            
            let statusText = 'Bilinmeyen';
            let statusClass = '';
            
            switch(state) {
                case 'new':
                    statusText = 'Bağlanıyor...';
                    statusClass = 'connecting';
                    break;
                case 'connecting':
                    statusText = 'Bağlanıyor...';
                    statusClass = 'connecting';
                    break;
                case 'connected':
                    statusText = 'Bağlandı';
                    statusClass = 'connected';
                    // 3 saniye sonra durumu gizle
                    setTimeout(() => {
                        statusElement.style.opacity = '0';
                    }, 3000);
                    break;
                case 'disconnected':
                    statusText = 'Bağlantı Kesildi';
                    statusClass = 'disconnected';
                    break;
                case 'failed':
                    statusText = 'Bağlantı Başarısız';
                    statusClass = 'failed';
                    break;
                case 'closed':
                    statusText = 'Bağlantı Kapatıldı';
                    statusClass = 'closed';
                    break;
            }
            
            statusElement.innerText = statusText;
            statusElement.className = `connection-status ${statusClass}`;
            statusElement.style.opacity = '1';
        }

        // Mikrofonu açıp kapatır
        function toggleMic() {
            localAudioEnabled = !localAudioEnabled;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = localAudioEnabled;
            });
            
            // Simgeyi güncelle
            micToggle.innerHTML = localAudioEnabled 
                ? '<i class="fas fa-microphone"></i>' 
                : '<i class="fas fa-microphone-slash"></i>';
        }

        // Kamerayı açıp kapatır
        function toggleVideo() {
            localVideoEnabled = !localVideoEnabled;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = localVideoEnabled;
            });
            
            // Simgeyi güncelle
            videoToggle.innerHTML = localVideoEnabled 
                ? '<i class="fas fa-video"></i>' 
                : '<i class="fas fa-video-slash"></i>';
        }

        // Ekran paylaşımını başlatır veya durdurur
        async function toggleScreenShare() {
            try {
                if (screenShareToggle.classList.contains('active')) {
                    // Ekran paylaşımını durdur ve kameraya geri dön
                    localStream.getTracks().forEach(track => track.stop());
                    
                    // Kamera ve mikrofonu yeniden başlat
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    // Yerel video elementini güncelle
                    document.getElementById('video-local').srcObject = localStream;
                    
                    // Tüm bağlantıları güncelle
                    Object.keys(peers).forEach(peerId => {
                        const sender = peers[peerId].getSenders().find(s => s.track.kind === 'video');
                        if (sender) {
                            sender.replaceTrack(localStream.getVideoTracks()[0]);
                        }
                    });
                    
                    screenShareToggle.classList.remove('active');
                    screenShareToggle.innerHTML = '<i class="fas fa-desktop"></i>';
                } else {
                    // Ekran paylaşımını başlat
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true
                    });
                    
                    // Ekran paylaşımı durdurulduğunda
                    screenStream.getVideoTracks()[0].onended = async () => {
                        await toggleScreenShare();
                    };
                    
                    // Video izini değiştir
                    const videoTrack = screenStream.getVideoTracks()[0];
                    
                    // Yerel video elementini güncelle
                    document.getElementById('video-local').srcObject = new MediaStream([videoTrack]);
                    
                    // Tüm bağlantıları güncelle
                    Object.keys(peers).forEach(peerId => {
                        const sender = peers[peerId].getSenders().find(s => s.track.kind === 'video');
                        if (sender) {
                            sender.replaceTrack(videoTrack);
                        }
                    });
                    
                    screenShareToggle.classList.add('active');
                    screenShareToggle.innerHTML = '<i class="fas fa-stop"></i>';
                }
            } catch (error) {
                console.error('Ekran paylaşımı hatası:', error);
            }
        }

        // Görüşmeyi sonlandırır
        function hangup() {
            socket.emit('leave_room', { oda_id: roomId });
            
            // Tüm bağlantıları kapat
            Object.keys(peers).forEach(peerId => {
                peers[peerId].close();
                document.getElementById(`video-${peerId}`)?.remove();
            });
            
            // Yerel medya akışını durdur
            localStream.getTracks().forEach(track => track.stop());
            
            // Ana sayfaya yönlendir
            window.location.href = '/';
        }

        // Oda ID'sini panoya kopyalar
        function copyRoomId() {
            navigator.clipboard.writeText(roomId).then(() => {
                alert('Oda ID\'si panoya kopyalandı!');
            }).catch(err => {
                console.error('Kopyalama hatası:', err);
            });
        }

        // Sayfa kapatıldığında temizlik yap
        window.onbeforeunload = () => {
            socket?.emit('leave_room', { oda_id: roomId });
            localStream?.getTracks().forEach(track => track.stop());
        };

        // Video elementlerinin sayısına göre konteynerin sınıfını günceller
        function updateContainerLayout() {
            const totalVideos = document.querySelectorAll('.video-wrap').length;
            
            if (totalVideos === 1) {
                videoContainer.className = 'video-container one-user';
            } else if (totalVideos === 2) {
                videoContainer.className = 'video-container two-users';
            } else {
                videoContainer.className = 'video-container';
            }
            
            console.log(`Görünüm güncellendi: ${totalVideos} kullanıcı`);
        }

        // Belirli bir kalite seviyesinde video akışı başlatır
        async function startVideoWithQuality(qualityLevel) {
            try {
                // Önceki akışı temizle
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                
                console.log(`Video kalitesi ${qualityLevel} seviyesinde başlatılıyor`);
                
                // Yeni kamera ve mikrofon akışını başlat
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: videoQualitySettings[qualityLevel],
                    audio: true
                });
                
                // Yerel video elementini güncelle
                const localVideo = document.getElementById('video-local');
                if (localVideo) {
                    localVideo.srcObject = localStream;
                }
                
                // Tüm bağlantıları güncelle
                Object.keys(peers).forEach(userId => {
                    // Eski gönderileri bul ve kaldır
                    const senders = peers[userId].getSenders();
                    
                    // Yeni izleri ekle
                    localStream.getTracks().forEach(track => {
                        const sender = senders.find(s => s.track && s.track.kind === track.kind);
                        if (sender) {
                            // Var olan gönderici varsa, izi değiştir
                            console.log(`${userId} için ${track.kind} izi güncelleniyor`);
                            sender.replaceTrack(track);
                        } else {
                            // Yoksa yeni gönderici ekle
                            console.log(`${userId} için yeni ${track.kind} izi ekleniyor`);
                            peers[userId].addTrack(track, localStream);
                        }
                    });
                });
                
                // Düğmeleri güncelle
                if (micToggle) {
                    micToggle.innerHTML = '<i class="fas fa-microphone"></i>';
                    localAudioEnabled = true;
                }
                
                if (videoToggle) {
                    videoToggle.innerHTML = '<i class="fas fa-video"></i>';
                    localVideoEnabled = true;
                }
                
                // Kalite seviyesini kaydet
                currentQualityLevel = qualityLevel;
                
                // Kalite bilgisini göster
                showQualityIndicator(qualityLevel);
                
                return localStream;
            } catch (error) {
                console.error(`Video kalitesi ${qualityLevel} başlatılamadı:`, error);
                
                // Hata durumunda daha düşük kaliteye düş
                if (qualityLevel !== 'low' && error.name === 'OverconstrainedError') {
                    console.log('Daha düşük kalite deneniyor...');
                    return startVideoWithQuality('low');
                }
                
                throw error;
            }
        }
        
        // Bağlantı kalitesini kontrol eder ve gerekirse video kalitesini ayarlar
        function startConnectionQualityCheck() {
            // Zaten çalışıyorsa tekrar başlatma
            if (connectionQualityCheckInterval) return;
            
            console.log('Bağlantı kalitesi kontrolü başlatılıyor');
            
            connectionQualityCheckInterval = setInterval(async () => {
                // İstatistikleri al ve bağlantı hızını ölç
                try {
                    // En az bir peer bağlantısı olmalı
                    const userIds = Object.keys(peers);
                    if (userIds.length === 0) return;
                    
                    // İlk peer bağlantısının istatistiklerini al
                    const stats = await peers[userIds[0]].getStats();
                    let bytesReceived = 0;
                    let bytesSent = 0;
                    let timestamp = 0;
                    
                    // İstatistikleri analiz et
                    stats.forEach(report => {
                        if (report.type === 'transport') {
                            bytesReceived += report.bytesReceived || 0;
                            bytesSent += report.bytesSent || 0;
                            timestamp = report.timestamp;
                        }
                    });
                    
                    if (lastConnectionCheck) {
                        const timeDiff = (timestamp - lastConnectionCheck) / 1000; // saniye
                        if (timeDiff > 0) {
                            // Gönderme bant genişliği (kbps)
                            const uploadSpeed = ((bytesSent - lastConnectionCheck.bytesSent) * 8) / timeDiff / 1000;
                            
                            console.log(`Ölçülen yükleme hızı: ${uploadSpeed.toFixed(2)} kbps`);
                            
                            // Kalite seviyesini hıza göre ayarla
                            let newQualityLevel = currentQualityLevel;
                            
                            if (uploadSpeed < 500) { // 500 kbps altı
                                newQualityLevel = 'low';
                            } else if (uploadSpeed >= 500 && uploadSpeed < 1500) { // 500-1500 kbps arası
                                newQualityLevel = 'medium';
                            } else if (uploadSpeed >= 1500) { // 1.5 Mbps üstü
                                newQualityLevel = 'high';
                            }
                            
                            // Sadece kalite değişecekse uygula
                            if (newQualityLevel !== currentQualityLevel) {
                                console.log(`Bağlantı hızı: ${uploadSpeed.toFixed(2)} kbps, kalite ${currentQualityLevel} -> ${newQualityLevel} olarak değiştiriliyor`);
                                await startVideoWithQuality(newQualityLevel);
                            }
                        }
                    }
                    
                    // Son kontrol bilgilerini kaydet
                    lastConnectionCheck = {
                        bytesReceived,
                        bytesSent,
                        timestamp
                    };
                    
                } catch (error) {
                    console.error('Bağlantı hızı kontrolü hatası:', error);
                }
            }, 10000); // Her 10 saniyede bir kontrol et
        }
        
        // Kalite göstergesini ekranda gösterir
        function showQualityIndicator(qualityLevel) {
            // Mevcut göstergeyi kontrol et
            let indicator = document.getElementById('quality-indicator');
            
            // Yoksa oluştur
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'quality-indicator';
                indicator.style.position = 'absolute';
                indicator.style.top = '10px';
                indicator.style.right = '10px';
                indicator.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                indicator.style.color = 'white';
                indicator.style.padding = '5px 10px';
                indicator.style.borderRadius = '4px';
                indicator.style.fontSize = '12px';
                indicator.style.zIndex = '1000';
                indicator.style.transition = 'opacity 0.5s';
                
                // Belirli bir süre sonra göstergeyi gizle
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 3000);
                
                // Hover olunca tekrar göster
                indicator.onmouseenter = () => {
                    indicator.style.opacity = '1';
                };
                
                indicator.onmouseleave = () => {
                    indicator.style.opacity = '0';
                };
                
                document.body.appendChild(indicator);
            }
            
            // İçeriği güncelle
            let qualityText = '';
            let colorClass = '';
            
            switch (qualityLevel) {
                case 'low':
                    qualityText = 'Düşük Kalite';
                    colorClass = 'quality-low';
                    indicator.style.backgroundColor = 'rgba(231, 76, 60, 0.7)';
                    break;
                case 'medium':
                    qualityText = 'Orta Kalite';
                    colorClass = 'quality-medium';
                    indicator.style.backgroundColor = 'rgba(241, 196, 15, 0.7)';
                    break;
                case 'high':
                    qualityText = 'Yüksek Kalite';
                    colorClass = 'quality-high';
                    indicator.style.backgroundColor = 'rgba(46, 204, 113, 0.7)';
                    break;
            }
            
            indicator.textContent = qualityText;
            indicator.className = `quality-indicator ${colorClass}`;
            indicator.style.opacity = '1';
        }
        
        // Manuel olarak video kalitesini değiştirmek için
        function changeVideoQuality(qualityLevel) {
            if (videoQualitySettings[qualityLevel]) {
                startVideoWithQuality(qualityLevel)
                    .then(() => {
                        console.log(`Video kalitesi manuel olarak ${qualityLevel} seviyesine ayarlandı`);
                    })
                    .catch(error => {
                        console.error(`Manuel video kalitesi değiştirme hatası:`, error);
                    });
            }
        }

        // Otomatik kalite ayarını açıp kapatır
        let automaticQualityEnabled = true;
        
        function toggleAutomaticQuality() {
            automaticQualityEnabled = !automaticQualityEnabled;
            document.getElementById('autoQualityToggle').checked = automaticQualityEnabled;
            
            if (automaticQualityEnabled) {
                console.log('Otomatik kalite ayarı etkinleştirildi');
                startConnectionQualityCheck();
            } else {
                console.log('Otomatik kalite ayarı devre dışı bırakıldı');
                if (connectionQualityCheckInterval) {
                    clearInterval(connectionQualityCheckInterval);
                    connectionQualityCheckInterval = null;
                }
            }
        }
    </script>
</body>
</html> 